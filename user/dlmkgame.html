<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>管理后台</title>
<link rel="stylesheet" href="/layui/css/layui.css">
<link rel="stylesheet" href="/layui/lay/modules/webuploader.css">
<style>
.layui-form{padding-top:10px;}
</style>
</head>
<body>
<div class="layui-layout layui-layout-admin">

    <div id="view" style="padding:20px;"> 
    
        <p style="padding:10px 20px;"><i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop" style="color:red;">&#xe63d;</i> 加载中...</p>
    </div>

    <script id="select" type="text/html">
    <table class="layui-table" >

        <colgroup>

            {{# if( $(window).width() > 700){ }}


            <col>

            {{# } }}

            
            <col>
            <col>
         
        </colgroup>

        <thead>

            <tr>

                <th>游戏</th>

                <th>房间</th>

                {{# if( $(window).width() > 700){ }}

                    <th>时间</th>
                {{# } }}

               
             
               
            </tr>
            
        </thead>
        <tbody>

        {{#  layui.each(d, function(index, item){ }}
  
            <tr id="tb{{ item.id }}">

              

          
                <td> {{ GAME[item.gameid] }}</td>

                <td><button class="layui-btn" onclick="edit({{ item.id }});"><i class="layui-icon">&#xe642;</i>详情</button> {{ item.fangid }} </td>

                {{# if( $(window).width() > 700){ }}

                   
                    
                    <td>{{ time(item.atime) }}</td>
                {{# } }}

                
               
  
              

            </tr>

        {{# }); }}
    </tbody>
</table>


    


    </script>
    <div class="baoqi" style="padding:0px 20px;">

        <button class="layui-btn layui-btn-normal  layui-btn-small" onclick="add();" style="float:left;margin-right:18px;margin-top:10px;"><i class="layui-icon">&#xe654;</i> 新建房间 </button>

        <div id="page" style="float:left;"></div>

    </div>

</div>


</body>
</html>
<script src="/layui/layui.js"></script>
<script src="/layui/lay/modules/jquery-3.2.1.min.js"></script>
<script src="/layui/lay/modules/webuploader.js"></script>

<script>
QT = 2;
var UID = 0;
var MODE = 'dlmkgame';
var NUM = 8;
var pg = 1;
var ID = 0;
var GAME;
var shuzhi;
var DASUZU = {};
var BIZHONG;
layui.config({
  base: '/layui/lay/modules/'
});


function qtdenglu(){
    
    layer.closeAll();
    window.location.href="user.html";

}

function dbdel(ID){

}


function edit(ID){

    $.ajax({

        url:USIN,
        type: "POST",
        data:{y:MODE,d:"get",id:ID,ttoken:TOKEN,apptoken:getCookie("apptoken")},
        dataType: "json",
        timeout:"3000",
        success: function(data){

            if(data.token && data.token != ""){
            
                TOKEN = data.token;
            }

            D = data.data;


            html = '<table class="layui-table">';



            if( D ){

                UID = D.uid;
                html +='<thead><tr><th>局数</th>';
                html +='<th>详细数据</th>';
                html +='</tr></thead>';
                html += '<tbody>';

                gamemin = D.data;

                for(var M in gamemin){

                    html +='<tr>';

                   
                    html +='<td>'+gamemin[M].qishu+'</td>';

                        html +='<td>';
                        html += '<table class="layui-table">';
                        html += '<thead><tr><th>用户</th><th>本局</th><th>总分</th></tr></thead><tbody>';

                        userinfo = gamemin[M].games.userinfo;
                        tongji = gamemin[M].games.tongji;
                        alltongji = gamemin[M].games.alltongji;


                        for(var mm in userinfo){

                            html+='<tr>';
                            html+='<td><img src="'+userinfo[mm].t+'" style="width:50px;height:50px"><br /><span  class="'+(UID==mm?'off0':'')+'">'+userinfo[mm].n+'</span></td>';


                            dang = tongji[mm];
                            zong = alltongji[mm];


                            html +='<td><span class="off'+(dang > 0?'1">+':'0">')+''+dang+'</span></td>';
                            html +='<td><span class="off'+(zong > 0?'1">+':'0">')+''+zong+'</span></td>';



                            html+='</tr>';
                        }

                        html += '</tbody></table>';
                        html +='</td>';

                    


                    html +='</tr>';
                
                }


                
                html += '</tbody>';
            }

            html += '<tr><td colspan="2"><button type="reset" class="layui-btn layui-btn-danger" onclick="layer.close(OPID);">返回</button></td></tr></table>';



            

            OPID = layer.open({
                type: 1,
                title:false,
                area: ['100%', '100%'],
                fixed: true, 
                maxmin: false,
                content: html
            });



        },error:function(XMLHttpRequest){

            ajaxfan(XMLHttpRequest);
        }

     });


}


function add(){

    $.ajax({

        url:USIN,
        type: "POST",
        data:{y:MODE,d:"put",ttoken:TOKEN,apptoken:getCookie("apptoken")},
        dataType: "json",
        timeout:"3000",
        success: function(data){

            if(data.token && data.token != ""){
            
                TOKEN = data.token;
            }

            D = data.data.data;

            if(data.data.bizhong){
            
                BIZHONG = data.data.bizhong;
            }

            if(D){

                html ='<form class="layui-form" style="padding:20px;"><select name="aihao" lay-filter="aihao">';

                for(var m in D){

                    DASUZU[m] = D[m];
  
                    html+= '<option value="'+m+'">'+D[m].name+'</option>';


                
                } 
        
      

                 html+= '</select></form>';

           

                OPID = layer.open({
                    type: 1,
                    title:"请选择要创建的游戏",
                     area: ["100%", "100%"],
                    fixed: true, 
                    maxmin: false,
                    content: html
                });

                form = layui.form();

                form.on('select(aihao)', function(data){

                    YOUXI = DASUZU[data.value];

                    html ='<form name="form" id="form" class="layui-form">';
                    BIAO = Array(
                        'name#游戏名字#textgbi##游戏名字#'+YOUXI.name+'#',
                        'huobi#消耗货币#textgbi##货币#'+BIZHONG[YOUXI.huobi]+'#',
                        'name#消耗数量#textgbi##消耗#'+YOUXI.fangka+'#',
                        'gid##hidden##消耗#'+data.value+'#',
                        
                     );
                    for(var z in BIAO){

                        html+=jsfrom(BIAO[z]);
                    }

                    POST = YOUXI.post;
                    POSTNAME = YOUXI.postname;

                    if(POST){

                        for(var G in POST){

                            shuzhi = POST[G];
                             console.log(shuzhi);

                             html+=jsfrom(G+'#'+POSTNAME[G]+'#selectk##shuzhi');
                        
                        }
                    }
                    
                    html+=jsfrom('tijiao##tjcz###立即创建#tijiao');
                    html+="</form>";

                    $("#layui-layer"+OPID+" .layui-layer-content").html(html);


                    form.on('submit(tijiao)', function(data){
 
                        dd = {y:MODE,d:"post",ttoken:TOKEN,apptoken:getCookie("apptoken")};
                        obj = Object.assign(dd,data.field);

                        $.ajax({

                            url:USIN,
                            type: "POST",
                            data:obj,
                            dataType: "json",
                            timeout:"3000",
                            success: function(data){

                                if(data.token && data.token != ""){
                                
                                    TOKEN = data.token;
                                }

                                if(data.code == 2){

                                    html = '<div style="width:300px;margin:10% auto;">房间创建成功ID: <span style="color:red;font-size:18px;">'+data.data+'</span></div>';

                                    $("#layui-layer"+OPID+" .layui-layer-content").html(html);
                                }

                                dbselect();

                            },error:function(XMLHttpRequest){

                                ajaxfan(XMLHttpRequest);
                            }

                        });

                        return false;
                    });
                    form.render(); 


                });

                form.render(); 
            
            
            }


         },error:function(XMLHttpRequest){

            ajaxfan(XMLHttpRequest);
        }

    });



}



function vwselect(data){

    laytpl = layui.laytpl;
    element = layui.element();
    form = layui.form();
    var tpl = document.getElementById('select').innerHTML;
    var render = laytpl(tpl).render(data.data);
    document.getElementById('view').innerHTML = render;
    element.init();

    form = layui.form();
    form.render('select'); 

}


function dbselect(){

    $.ajax({

        url:USIN,
        type: "POST",
        data:{y:MODE,d:"get",num:NUM,pg:pg,apptoken:getCookie("apptoken")},
        dataType: "json",
        timeout:"3000",
        success: function(data){

            if(data.token && data.token != ""){
            
                TOKEN = data.token;
            }

            D = data.data;

        

            if (D.game)
            {
                GAME = D.game;
            }

            if(data.code == 1){

                //layer.closeAll();
                vwselect(D);

            }else{

                $("#view").html('没有更多数据');
                

                layer.msg('没有更多数据');

            }

        },error:function(XMLHttpRequest){

            ajaxfan(XMLHttpRequest);
        }

    });
}

layui.use(['jquery','laytpl','laypage','layer','form', 'element','laydate'], function(){

    var layer = layui.layer,
    laydate =layui.laydate,
    upload =layui.upload,
    form = layui.form();
    $ = layui.jquery;
    var laytpl = layui.laytpl;
    var laypage = layui.laypage;

    dbselect();
    laypage({
        cont:'page',
        pages:10000000,
        skip:false,
        jump:function(obj,first)
        {
            if(!first){
                pg = obj.curr;
                dbselect();
            }
        }
    });

});

</script>



