<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>管理后台</title>
<link rel="stylesheet" href="/layui/css/layui.css">
<link rel="stylesheet" href="/layui/lay/modules/webuploader.css">

<style>
.aniuzu a{margin-bottom:10px;}
</style>

</head>
<body>
<div class="layui-layout layui-layout-admin">

    <div id="view" style="padding:20px;"> 
    
        <p style="padding:10px 20px;"><i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop" style="color:red;">&#xe63d;</i> 加载中...</p>
    </div>

    <script id="select" type="text/html">
    <table class="layui-table" >
        <colgroup>
            {{# if( $(window).width() > 700){ }}
                <col width="80">
        
            {{# } }}

                <col>

            {{# if( $(window).width() > 700){ }}
                
                <col>
        
             {{# } }}


                <col>
         
        </colgroup>
        <thead>
            <tr>
                {{# if( $(window).width() > 700){ }}

                    <th>ID</th>

                {{# } }}
                <th>管理</th>

                {{# if( $(window).width() > 700){ }}

                    <th>描述</th>

                {{# } }}

                <th>操作</th>
            </tr>
            
        </thead>
        <tbody>

            {{#  layui.each(d, function(index, item){ }}
          
            <tr id="tb{{ item.id }}">

                {{# if( $(window).width() > 700){ }}
                    <td>{{ item.id }}</td>
                {{# } }}

                    <td>{{ item.name }}</td>

                {{# if( $(window).width() > 700){ }}
                    <td>{{ item.miaoshu }}</td>
                {{# } }}




         





            
                <td>
                    <button class="layui-btn" onclick="edit({{ item.id }});"><i class="layui-icon">&#xe642;</i> 编辑</button>
                    <button class="layui-btn layui-btn-danger  layui-btn-small" onclick="dbdel({{ item.id }});"><i class="layui-icon">&#xe640;</i> 删除</button>

                </td>
            </tr>
            {{# }); }}

        </tbody>
    </table>
    </script>
    <div class="baoqi" style="padding:0px 20px;">

        <button class="layui-btn layui-btn-normal  layui-btn-small" onclick="add();" style="float:left;margin-right:18px;margin-top:10px;"><i class="layui-icon">&#xe654;</i> 新建 </button>
        <div id="page" style="float:left;"></div>

    </div>

</div>


     






</body>
</html>
<script src="/layui/layui.js"></script>
<script src="/layui/lay/modules/jquery-3.2.1.min.js"></script>
<script src="/layui/lay/modules/webuploader.js"></script>

<script>

var NUM = 10;
var pg = 1;
var off;
var yip;
var quanxin = Array();
var ID = 0;
var MODE = 'adminfenzu';
var CD;

var MOE = {"post":"\u589e\u52a0","delete":"\u5220\u9664","put":"\u4fee\u6539","get":"\u8bfb\u53d6","only":"\u53ea\u64cd\u4f5c\u81ea\u5df1"};

layui.config({
  base: '/layui/lay/modules/'
});


function dbdel(ID){

    /*删除数据*/

    layer.confirm('确定删除?', {icon: 3, title:'提示'}, function(index){

        $.ajax({

            url:TXIN,
            type: "POST",
            data:{y:MODE,d:"delete",id:ID,ttoken:TOKEN,apptoken:getCookie("apptoken")},
            dataType: "json",
            timeout:"3000",
            success: function(data){

                if(data.token && data.token != ""){
                
                    TOKEN = data.token;
                }

                if(data.code == 1){

                    $("#tb"+ID).remove();
                    layer.close(index);
                }

            },error:function(XMLHttpRequest){

                ajaxfan(XMLHttpRequest);
            }
        });

    });
}


function newjiexi(D){

    for(var z in D){

 

        var mm = D[z];
        $zifu='shezhi_'+z;
        $("#"+$zifu).prop("checked",true);

        for(var zi in mm){

         
            var mmm = mm[zi];

            $zifu='shezhi_'+z+'_'+zi;

            $("#"+$zifu).prop("checked",true);

            for(var zii in mmm){

                $zifu='shezhi_'+z+'_'+zi+'_'+zii+'';

                $("#"+$zifu).prop("checked",true);

 
            
            }

        }


       


    
    }
        form = layui.form();
      form.render('checkbox');

}


function edit(ID){

   
      html ='<form name="form" id="form" class="layui-form">';
    BIAO = Array(
        'name#权限名字#text##权限名字##required',
        'miaoshu#权限描述#textarea##权限描述##required'
      
    );

    for(var z in BIAO){

        html+=jsfrom(BIAO[z]);
   
    }

    html +='<div style="margin-left:20px;padding:10px 0;"  class="aniuzu"><a  class="layui-btn" href="javascript:void(0);" id="piliangquan">全选不全选</a>  <a  class="layui-btn layui-btn-normal" href="javascript:void(0);" id="piliapost"> 只增</a>  <a  class="layui-btn layui-btn-danger" href="javascript:void(0);" id="piliadelete"> 只删除</a> <a  class="layui-btn layui-btn-warm" href="javascript:void(0);" id="piliaput"> 只改</a> <a  class="layui-btn layui-btn-primary" href="javascript:void(0);" id="piliaget"> 只读</a> <a  class="layui-btn layui-btn-danger" href="javascript:void(0);" id="piliangxuan"> 全选/不全选 只操作自己</a></div>';

    if(CD){

        for(var g in CD ){

           html +='<div class="layui-form-item dingji" id="aaashezhi_'+CD[g].ac+'"> <div  style="height:60px;margin-left:20px;" class="xiaobiao" data="aaashezhi_'+CD[g].ac+'"> <input type="checkbox" value="" name="shezhi['+CD[g].ac+']" id="shezhi_'+CD[g].ac+'" title="'+CD[g].caidan+'" > </div>';

           if(CD[g].data){

               var LIN = CD[g].data;


   
               for(var m in LIN){


                    html +=' <div class="layui-input-block dingji2"> <input type="checkbox"   value="" name="shezhi['+CD[g].ac+']['+m+']" id="shezhi_'+CD[g].ac+'_'+m+'" title="'+LIN[m]+'">';

                    for(var jj in MOE){

                       
                            html +=' <input type="checkbox" class="a'+jj+'"  value="" id="shezhi_'+CD[g].ac+'_'+m+'_'+jj+'"  name="shezhi['+CD[g].ac+']['+m+']['+jj+']" title="'+MOE[jj]+'"> ';

   
                    }

                     html +="</div>";




               
               }
           

           
           
           }




           html+='</div>';
        
        }
    
    }
    BIAO = Array( 'tijiao##tjcz###立即修改#tijiao' );
     for(var z in BIAO){

        html+=jsfrom(BIAO[z]);
   
    }

    html+="</form>";
    OPID =layer.open({
        type: 1,
        title:false,
        area: ['100%', '100%'],
        fixed: true, 
        maxmin: false,
        content: html
        });


    form = layui.form();

    $("#piliangquan").click(function(){

        

        var l =$("input:checked").length;
        if(l > 0){


            $("input:checkbox").prop("checked",false);
        
        
        }else{

            $("input:checkbox").prop("checked",true);

        }

        form.render('checkbox');

    });

    $("#piliangxuan").click(function(){

        var l = $("input.aonly:checked").length;
        if(l > 0) $("input.aonly:checkbox").prop("checked",false);
        else  $("input.aonly:checkbox").prop("checked",true);

        form.render('checkbox');
    });




    $(".dingji .xiaobiao").click(function(){


        form = layui.form();
        form.render('checkbox');
        idd = $(this).attr('data');
        var l = $("#"+idd).find("input:checked").length;
        if(l > 1) $("#"+idd).find("input:checkbox").prop("checked",false);
        else  $("#"+idd).find("input:checkbox").prop("checked",true);

        form.render('checkbox');

    });

    


    $("#piliaget").click(function(){

        var l = $("input.aget:checked").length;
        if(l > 0) $("input.aget:checkbox").prop("checked",false);
        else  $("input.aget:checkbox").prop("checked",true);

        form.render('checkbox');
    });

    $("#piliapost").click(function(){

        var l = $("input.apost:checked").length;
        if(l > 0) $("input.apost:checkbox").prop("checked",false);
        else  $("input.apost:checkbox").prop("checked",true);

        form.render('checkbox');
    });

    $("#piliadelete").click(function(){

        var l = $("input.adelete:checked").length;
        if(l > 0) $("input.adelete:checkbox").prop("checked",false);
        else  $("input.adelete:checkbox").prop("checked",true);

        form.render('checkbox');
    });

     $("#piliaput").click(function(){

        var l = $("input.aput:checked").length;
        if(l > 0) $("input.aput:checkbox").prop("checked",false);
        else  $("input.aput:checkbox").prop("checked",true);

        form.render('checkbox');
    });


    $.ajax({

            url:TXIN,
            type: "POST",
            data:{y:MODE,d:"get",id:ID,ttoken:TOKEN,apptoken:getCookie("apptoken")},
            dataType: "json",
            timeout:"3000",
            success: function(data){

                if(data.token && data.token != ""){
                
                    TOKEN = data.token;
                }

                if(data.code == 1){

                    D = data.data;

                    for(var H in D){

                        $("[name="+H+"]").val(D[H]);

                        if(H == 'shezhi'){
                        
                            newjiexi(D[H]);
                        }

                    
                    }
                    form = layui.form();
                    form.render();
                    
                }

            },error:function(XMLHttpRequest){

                ajaxfan(XMLHttpRequest);
            }

        });



    form = layui.form();
    form.on('submit(tijiao)', function(data){
     
       

        dd = {y:MODE,d:"put",id:ID,ttoken:TOKEN,apptoken:getCookie("apptoken")};
        obj = $.extend(dd,data.field);

        $.ajax({

            url:TXIN,
            type: "POST",
            data:obj,
            dataType: "json",
            timeout:"3000",
            success: function(data){

                if(data.token && data.token != ""){
                
                    TOKEN = data.token;
                }

                if(data.code == 1){
                    layer.close(OPID);
dbselect();

                }

            },error:function(XMLHttpRequest){

                ajaxfan(XMLHttpRequest);
            }

        });

        return false;
    });
    form.render();


}

function add(ID){

    /*新建数据*/
    
    

    html ='<form name="form" id="form" class="layui-form">';
    BIAO = Array(
        'name#权限名字#text##权限名字##required',
        'miaoshu#权限描述#textarea##权限描述##required'
      
    );

    for(var z in BIAO){

        html+=jsfrom(BIAO[z]);
   
    }

    html +='<div style="margin-left:20px;padding:10px 0;" class="aniuzu"><a  class="layui-btn" href="javascript:void(0);" id="piliangquan">全选不全选</a>  <a  class="layui-btn layui-btn-normal" href="javascript:void(0);" id="piliapost"> 只增</a>  <a  class="layui-btn layui-btn-danger" href="javascript:void(0);" id="piliadelete"> 只删除</a> <a  class="layui-btn layui-btn-warm" href="javascript:void(0);" id="piliaput"> 只改</a> <a  class="layui-btn layui-btn-primary" href="javascript:void(0);" id="piliaget"> 只读</a> <a  class="layui-btn layui-btn-danger" href="javascript:void(0);" id="piliangxuan"> 全选/不全选 只操作自己</a></div>';

    if(CD){



        for(var g in CD ){

           html +='<div class="layui-form-item dingji" id="aashezhi_'+CD[g].ac+'"> <div  style="height:60px;margin-left:20px;"     class="xiaobiao" data="aashezhi_'+CD[g].ac+'"> <input type="checkbox"   name="shezhi['+CD[g].ac+']" id="shezhi_'+CD[g].ac+'" title="'+CD[g].caidan+'" > </div>';

           if(CD[g].data){

               var LIN = CD[g].data;


   
               for(var m in LIN){


                    html +=' <div class="layui-input-block dingji2"> <input type="checkbox"   value="" name="shezhi['+CD[g].ac+']['+m+']" id="shezhi_'+CD[g].ac+'_'+m+'" title="'+LIN[m]+'">';

                    for(var jj in MOE){

                       
                            html +=' <input type="checkbox" class="a'+jj+'"  value="" id="shezhi_'+CD[g].ac+'_'+m+'_'+jj+'"  name="shezhi['+CD[g].ac+']['+m+']['+jj+']" title="'+MOE[jj]+'"> ';

   
                    }

                     html +="</div>";




               
               }
           

           
           
           }




           html+='</div>';
        
        }
    
    }
    BIAO = Array( 'tijiao##tjcz###立即新增#tijiao');
     for(var z in BIAO){

        html+=jsfrom(BIAO[z]);
   
    }

    html+="</form>";

    OPID = layer.open({
        type: 1,
        title:false,
        area: ['100%', '100%'],
        fixed: true, 
        maxmin: false,
        content: html
        });



    form = layui.form();

    $("#piliangquan").click(function(){

        

        var l =$("input:checked").length;
        if(l > 0){


            $("input:checkbox").prop("checked",false);
        
        
        }else{

            $("input:checkbox").prop("checked",true);

        }

        form.render('checkbox');

    });

    $("#piliangxuan").click(function(){

        var l = $("input.aonly:checked").length;
        if(l > 0) $("input.aonly:checkbox").prop("checked",false);
        else  $("input.aonly:checkbox").prop("checked",true);

        form.render('checkbox');
    });


    $(".dingji .xiaobiao").click(function(){


        form = layui.form();
        form.render('checkbox');
        idd = $(this).attr('data');

        var l = $("#"+idd).find("input:checked").length;
        if(l > 1) $("#"+idd).find("input:checkbox").prop("checked",false);
        else  $("#"+idd).find("input:checkbox").prop("checked",true);

        form.render('checkbox');

    });

    


    $("#piliaget").click(function(){

        var l = $("input.aget:checked").length;
        if(l > 0) $("input.aget:checkbox").prop("checked",false);
        else  $("input.aget:checkbox").prop("checked",true);

        form.render('checkbox');
    });

    $("#piliapost").click(function(){

        var l = $("input.apost:checked").length;
        if(l > 0) $("input.apost:checkbox").prop("checked",false);
        else  $("input.apost:checkbox").prop("checked",true);

        form.render('checkbox');
    });

    $("#piliadelete").click(function(){

        var l = $("input.adelete:checked").length;
        if(l > 0) $("input.adelete:checkbox").prop("checked",false);
        else  $("input.adelete:checkbox").prop("checked",true);

        form.render('checkbox');
    });

     $("#piliaput").click(function(){

        var l = $("input.aput:checked").length;
        if(l > 0) $("input.aput:checkbox").prop("checked",false);
        else  $("input.aput:checkbox").prop("checked",true);

        form.render('checkbox');
    });


    form.on('submit(tijiao)', function(data){
     
       

        dd = {y:MODE,d:"post",ttoken:TOKEN,apptoken:getCookie("apptoken")};
        obj = $.extend(dd,data.field);

        $.ajax({

            url:TXIN,
            type: "POST",
            data:obj,
            dataType: "json",
            timeout:"3000",
            success: function(data){

                if(data.token && data.token != ""){
                
                    TOKEN = data.token;
                }

                if(data.code == 1){

                    layer.close(OPID);
                    dbselect();
                }

            },error:function(XMLHttpRequest){

                ajaxfan(XMLHttpRequest);
            }

        });

        return false;
    });

    form.render();
}



function vwselect(data){

    laytpl = layui.laytpl;
    element = layui.element();
   

    var tpl = document.getElementById('select').innerHTML;

    var render = laytpl(tpl).render(data.data);
    document.getElementById('view').innerHTML = render;
    element.init();
 
}


function dbselect(){

    $(".baoqi").show();

    $.ajax({

        url:TXIN,
        type: "POST",
        data:{y:MODE,d:"get",num:NUM,pg:pg,apptoken:getCookie("apptoken")},
        dataType: "json",
        timeout:"3000",
        success: function(data){

            if(data.token && data.token != ""){
            
                TOKEN = data.token;
            }

            D = data.data;


            if(D && D.cd){
            
                CD = D.cd;
            
            }

            if(data.code == 1){

               

                layer.closeAll();

               

                vwselect(data.data);

            }else{

                layer.msg('没有更多数据');

            }


        },error:function(XMLHttpRequest){

            ajaxfan(XMLHttpRequest);
        }

    });

    



}

function dbfind(data){


}



layui.use(['jquery','laytpl','laypage','layer','form', 'element','laydate'], function(){


    var layer = layui.layer,
 
    laydate =layui.laydate,
    upload =layui.upload,
    form = layui.form();
    $ = layui.jquery;
    var laytpl = layui.laytpl;
    var laypage = layui.laypage;

    dbselect();
    laypage({
    cont: 'page'
  
    ,pages: 10000000
    ,skip: false
    ,jump: function(obj, first){
            if(!first){

                pg = obj.curr;
                dbselect();
            }
           
        }
    });

});

</script>



